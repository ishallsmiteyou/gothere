package password

import (
    "crypto/sha256"
    "encoding/hex"
    "strings"
    "gothere/utils"
)

func hashPassword(plain, salt string) string {
    /* 
     * Main password hashing function.
     * It takes plain-text password and a salt to use
     * and returns hashed password.
     * Uses SHA256.
     */

    cycles := 1000
    hashed := plain
    for i := 0; i < cycles; i++ {
        hash := sha256.New()
        hash.Write([]byte(hashed))
        md := hash.Sum(nil)
        hashed = hex.EncodeToString(md)
    }

    hash := sha256.New()
    hash.Write([]byte(salt+hashed))
    md := hash.Sum(nil)
    return hex.EncodeToString(md)
}

func NewPassword(plain string) (string) {
    /* 
     * Generates a random salt and hashes given password
     * to be stored in DB.
     * Uses hashPassword() func from this package.
     * Formated as "SALT|HASH"
     */

    salt := utils.RandomStr(16)
    return salt+"|"+hashPassword(plain, salt)
}

func Authenticate(plain, hashed string) bool{
    /* 
     * Returns true if passwords match,
     * false otherwise.
     * Checks if a given password matches
     * hashed one retrieved from a DB,
     * Uses hashPassword() from this package.
     */

    if hashed == "" {
        return false
    }
    split := strings.Split(hashed, "|")
    if len(split) != 2 {
        return false
    }
    return split[1] == hashPassword(plain, split[0])
}
